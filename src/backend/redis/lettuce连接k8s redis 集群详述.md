## lettuce连接k8s redis 集群详述

[TOC]

### 1. k8s redis集群

#### 1.1. 初始环境信息

k8s集群：172.16.61.120 ~ 125

namespace: rhine-uat

clusterIp None Service: redis-svc

3主3从结构

|   pod   |  ip  |     slot      | Master/Slave |
| :-----: | :--: | :-----------: | :----------: |
| redis-0 |  45  |   (0-5460)    |    Master    |
| redis-1 |  67  | (5461-10922)  |    Master    |
| redis-5 |  94  | (10923-16383) |    Master    |
| redis-2 | 126  |               |    Slave     |
| redis-4 |  43  |               |    Slave     |
| redis-3 | 122  |               |    Slave     |

#### 1.2. pod调度问题

一个redis的pod会绑定一个PV Claims

如果某个redis pod（如redis-0）挂了，k8s会自动帮你部署一个新的pod（也叫redis-0），且会从PV Claims中去拉取信息重新加入集群

### 2. Redis集群的故障转移

redis集群节点间会保持通信（ping/pong）

（1）主观下线：某一个节点发现另一个节点A下线了，把它标记成pfail

（2）客观下线：半数以上的主节点标记节点A下线，把A客观下线，标记为fail

（3）选举：选举slave节点为master

选举采用RAFT算法，选举期间集群不可用

当过半数的master挂掉了，集群就fail了

### 3. Lettuce连接redis集群的基本内容

服务启动，lettuce根据配置的clusterNodes，从集群获取到了一个拓扑（Partitions）

默认情况下是**不开启**拓扑刷新的，也就是说，Partitions初始化了之后，就不再改变了

所以master一旦发生变化（比如下线，哪怕slave顶上来，集群可用，但是客户端还是连的原来的master做操作，所以会执行命令失败，ip漂移同理），客户端这边就无法正常执行到该master的命令了

所以解决这个问题的方法就是，让lettuce开启刷新拓扑的功能

### 4. 现象分析（针对于k8s环境）

#### 4.1. 一个master下线

一个master pod（如redis-0）下线的话，所要经历的事为：

对于redis集群本身，节点通信，最终把它标识成fail，再到选举slave顶上来

对于k8s来说，发现redis-0下线了，重新部署一个pod

两者是并行做的

一般来说应该是slave顶上来比较快（目前只有一个从节点，多从未尝试过），然后新的pod重新部署好了，加入集群了，通信之后发现已经有master了，自己就成了slave



从master下线，再到这个集群可用（由于需要选举，期间集群不可用），这是需要时间的

#### 4.2. k8s 节点关机，断电等，导致过半数master下线

对于redis集群而言，过半数master下线，集群fail，而且无法选举从节点顶上，集群间还是不断通信，看master是否恢复了

对于k8s来说，k8s自动调度，重新部署那些下线的pod

两者也是并行的

这时候会有很多种情况，假设是挂了2个master（redis-0，redis-1）节点（三主三从结构）

（1）k8s先部署一个pod redis-0成功，redis集群发现有2个master活着了，开始选举，把redis-1的从节点选举上来成了master，这时候k8s才把redis-1节点部署成功，重新加入集群，redis-1就成了slave

（2）k8s部署一个pod redis-0成功之后，redis集群还没开始选举，pod redis-1也部署好了重新加入集群，集群通信发现redis-1也重新上线了，这时候就不需要选举了，redis-0和redis-1还是master

#### 4.3. Lettuce客户端连接恢复

上面2种情况都是集群恢复的现象，且都是需要时间的，这个时间是集群不可用到恢复的时间，我们无法控制，大概需要10多秒时间

对于Lettuce客户端而言，刷新有2种机制，一种是自适应刷新（可配置发生moved，ask重定向，节点失联时）触发刷新拓扑，一种是开启定时任务，周期性去刷新拓扑

自适应刷新，同时触发了多个触发器，只会执行一次刷新任务，本次的其他触发会被忽略，这个任务的超时时间是默认30秒

定时任务刷新，默认时间是60秒刷新一次

假设一个连接，已经连接上了redis-0，这个时候redis-0下线了，它会重新尝试（默认）5次连接该节点（运用netty的连接，从log的反馈上看，一般会出现5次报错：ip cannot connect，时间大概是5-10秒），连接5次之后还是没连上，就触发了刷新拓扑的操作

另一种是周期性刷新，定期更新拓扑，具体的连接如何处理，将会在源码分析种介绍



也就是说，当k8s上的redis集群出现变化时，再到客户端感知并恢复，关键的时间点就在于

（1）redis集群的恢复时间

（2）lettuce感知到连接超时，再到触发刷新拓扑（之后的连接才是正常的）完成所需要的时间，无法配置时间，但是可以配置重尝试次数，默认5次

（3）定时任务刷新拓扑，默认是60秒刷新一次，可配置

### 5. Lettuce源码详解

@import "Lettuce 源码详解.md"











